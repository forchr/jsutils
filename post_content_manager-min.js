function SubjectContentManager(){StoreManager.call(this,["contentIndex","subjectIndex","templateUsed","random","subjects","contents","userTemplateData"],"subcnt.");this.subjects=[];this.contents=[];this.userTemplateData={};this.templateDataTopVariable="v";this.contentIndex=-1;this.subjectIndex=-1;this.templateUsed=false;this.random=false;this.uiTitle="内容"}SubjectContentManager.prototype=Object.create(StoreManager.prototype);SubjectContentManager.prototype.constructor=SubjectContentManager;SubjectContentManager.prototype.fromStoreValue=function(b,a){if(a&&_.isString(a)&&_.indexOf(["subjects","contents","userTemplateData"],b)>=0){return JSON.parse(a)}return a};SubjectContentManager.prototype.getUIPropId=function(a){return eventLoopId+"-subcnt-"+a};SubjectContentManager.prototype.setData=function(b,c,a){debug("主题数量: "+b.length);debug("内容数量: "+c.length);this.subjects=b;this.contents=c;this.userTemplateData=a;this.reset();return this};SubjectContentManager.prototype.isRandom=function(){return this.random};SubjectContentManager.prototype.storeStatus=function(){this.storeProp("subjectIndex","contentIndex");return this};SubjectContentManager.prototype.reset=function(){this.subjectIndex=-1;this.contentIndex=-1;this.storeStatus();debug("重置内容发送状态。");return this};SubjectContentManager.prototype.getTotal=function(){return this.subjects.length};SubjectContentManager.prototype.isTemplateUsed=function(){return this.templateUsed};SubjectContentManager.prototype.getUserTemplateData=function(){return this.userTemplateData};SubjectContentManager.prototype.setUserTemplateData=function(a){this.userTemplateData=a;return this};SubjectContentManager.prototype.getSubjectTotal=function(){return this.subjects.length};SubjectContentManager.prototype.getContentTotal=function(){return this.contents.length};SubjectContentManager.prototype.nextData=function(b,c){if(c.length===0){return null}var a;if(c.length>1&&this.random===true){a=_.random(0,c.length-1)}else{a=this[b]+1;if(a>=c.length){a=0}}this[b]=a;return c[a]};SubjectContentManager.prototype.nextSubject=function(){return this.nextData("subjectIndex",this.subjects)};SubjectContentManager.prototype.nextContent=function(){return this.nextData("contentIndex",this.contents)};SubjectContentManager.prototype.buildUI=function(){var l=this;this.$ui=jQuery("<div class='cnt'/>");var j=this.templateDataTopVariable;function k(i){return"<span style='padding:2px;color:#1824E7;'>&lt;%= "+j+"."+i+" %&gt;</span>"}helps.push("主题和正文都允许填写多个。");helps.push("主题和正文都可以是"+textLinkTemplate({url:"http://underscorejs.org/#template",text:"内含变量的内容模板",title:"点击查看如何使用"})+"，在其中可使用变量，在顶级变量"+j+"下引用系统变量和自己定义的变量。系统提供的变量："+k("d")+"引用日期，"+k("t")+"引用时间，"+k("dt")+"引用日期时间，"+k("to")+"引用收件地址；在正文还有额外的变量："+k("subject")+"引用主题。");var c={width:"97%",height:"130px","font-family":"inherit","font-size":"inherit"};var h={};var g=jQuery("<div/>").appendTo(this.$ui);this.$subjects=jQuery("<textarea class='enableWhenStop'/>").css(c).appendTo(g);jQuery("<div/>").html("一行一个主题。").appendTo(g);if(this.subjects.length>0){this.$subjects.val(this.subjects.join("\r\n"))}h.subject={title:"主题",$e:g};g=jQuery("<div/>").appendTo(this.$ui);this.$contents=jQuery("<textarea class='enableWhenStop'/>").css(c).appendTo(g);if(this.contents.length>0){this.$contents.val(this.contents.join("\r\n\r\n.\r\n\r\n"))}jQuery("<div/>").html("用独占一行的单个英文点号分隔多个正文内容。").appendTo(g);h.content={title:"正文",$e:g};g=jQuery("<div/>").appendTo(this.$ui);this.$userTemplateData=jQuery("<textarea class='enableWhenStop'/>").css(c).appendTo(g);jQuery("<div/>").html("自定义变量必须包含在"+textLinkTemplate({url:"http://json.org/",text:"JSON object",title:"点击查看如何使用"})+"中，即你输入的是一个JSON object，其中有你的变量。").appendTo(g);this.$userTemplateData.val(JSON.stringify(this.userTemplateData||{},null,2));h.userTemplateData={title:"变量",$e:g};var e=jQuery("<div class='ui-layout-north'/>").appendTo(this.$ui);var d=jQuery("<div class='ui-layout-center'/>").appendTo(this.$ui);var a=jQuery("<span/>").css(columnCss).appendTo(e);var f=0;_.each(h,function(m,i){var n=eventLoopId+"UI_subcnt_"+(f++);m.$e.attr("id",n).appendTo(d);if(f>1){m.$e.hide()}jQuery('<input type="radio" name="subcntRadio"/>').attr({id:"s_"+n,checked:(f>1?false:true)}).appendTo(a).click(function(o){d.children().hide();jQuery("#"+this.id.substring(2)).show()});jQuery("<label/>").attr("for","s_"+n).text(m.title).appendTo(a)});a.buttonset();var b=this.getUIPropId("templateUsed");jQuery("<input type='checkbox' value='1' class='enableWhenStop'/>").attr({title:"如果主题或内容含有变量，请打勾！",id:b}).prop("checked",l.templateUsed).appendTo(e).change(function(i){l.templateUsed=this.checked;l.storeProp("templateUsed")});jQuery("<label/>").attr("for",b).css(columnCss).text("启用变量").appendTo(e);b=this.getUIPropId("random");jQuery("<input type='checkbox' value='1' class='enableWhenStop'/>").attr({id:b}).prop("checked",l.random).appendTo(e).change(function(i){l.random=this.checked;l.storeProp("random")});jQuery("<label/>").attr("for",b).css(columnCss).text("随机选择").appendTo(e);g=jQuery("<div/>").css(rowCss).appendTo(this.$ui);jQuery("<button title='确定修改后请按' class='enableWhenStop'/>").appendTo(e).css(columnCss).button({label:"保存"}).click(function(q){var n=jQuery.trim(l.$subjects.val());var m,i,r;if(n.length===0){m=[]}else{m=n.split(/[\r\n]+/)}n=jQuery.trim(l.$contents.val());if(n.length===0){i=[]}else{i=n.split(/[\r\n]+\.[\r\n]+/)}n=jQuery.trim(l.$userTemplateData.val());if(n.length===0){r=[]}else{try{r=JSON.parse(n)}catch(p){confirmMessage(p);return}}try{l.setData(m,i,r).storeProp("subjects","contents","userTemplateData")}catch(p){confirmMessage(p)}});jQuery("<button title='恢复到修改前' class='enableWhenStop'/>").button({label:"恢复"}).appendTo(e).click(function(i){l.$subjects.val(l.subjects.join("\r\n"));l.$contents.val(l.subjects.join("\r\n.\r\n"));l.$userTemplateData.val(JSON.stringify(l.userTemplateData||{},null,2))});return this.$ui};
