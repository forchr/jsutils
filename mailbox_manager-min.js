var validHostNameRegex=new RegExp("^([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9])(.([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9]))*$");function ReceiverMailboxManager(){StoreManager.call(this,["addrs","eMin","eMax","defaultHostName"],"to.");this.sender={};this.addressTextSeperatorRegex=/(?:[\r\n,;])+/;this.addrs=TAFFY();this.eMin=1;this.eMax=5;this.uiTitle="邮箱";this.noFetch=false;this.urls={request:{label:"取接收邮箱网址",dv:"http://localhost:9080/sendmail/request"},report:{label:"发完汇报网址",dv:"http://localhost:9080/sendmail/finish"},save:{label:"保存邮箱网址",dv:"http://localhost:9080/mailbox/save"}};jQuery.each(this.urls,function(a,b){b.value=GM_getValue("url_"+a,b.dv)});this.mbStatus={normal:4,notExist:1,serverForbidden:2};this.smStatus={sendSuccess:1,deliverSuccess:2,sendFail:3,notSend:4}}ReceiverMailboxManager.prototype=Object.create(StoreManager.prototype);ReceiverMailboxManager.prototype.constructor=ReceiverMailboxManager;ReceiverMailboxManager.prototype.getUIPropId=function(a){return eventLoopId+"-to-"+a};ReceiverMailboxManager.prototype.buildAddrObj=function(a){return{addr:a,sent:false}};ReceiverMailboxManager.prototype.fromStoreValue=function(b,a){if(b==="addrs"){return TAFFY(a)}return a};ReceiverMailboxManager.prototype.toStoreValue=function(b,a){if(b==="addrs"){if(this.addrs&&this.addrs().count()>0){return this.addrs().stringify()}else{return undefined}}return a};ReceiverMailboxManager.prototype.storeStatus=function(){this.storeProp("addrs");this.showAddrs();return this};ReceiverMailboxManager.prototype.setAddrs=function(b,c){this.addrs=TAFFY();if(b.length){_.each(b,function(a,d){a=a.toLowerCase();this.addrs.insert(this.buildAddrObj(a))},this);if(c&&this.canPostMailbox()){this.postMailbox(b,this.mbStatus.normal)}}debug("邮箱数:"+b.length);return this};ReceiverMailboxManager.prototype.addAddrs=function(b,c){if(b.length){_.each(b,function(a,d){a=a.toLowerCase();if(this.addrs({addr:a,sent:false}).count()===0){this.addrs.insert(this.buildAddrObj(a))}},this);if(c&&this.canPostMailbox()){this.postMailbox(b,this.mbStatus.normal)}this.storeStatus();debug("邮箱数:"+b.length)}return this};ReceiverMailboxManager.prototype.sendAgain=function(){this.addrs().update({sent:false});this.storeStatus();return this};ReceiverMailboxManager.prototype.getUnsentCount=function(){return this.addrs({sent:false}).count()};ReceiverMailboxManager.prototype.hasUnsent=function(){return this.getUnsentCount()>0};ReceiverMailboxManager.prototype.getForSend=function(b){var a=this.getUnsentCount();if(a<1){return null}if(a>b){a=b}var c=this.eMin===this.eMax?this.eMax:_.random(this.eMin,this.eMax);if(c>a){c=a}return this.addrs({sent:false}).limit(c).select("addr")};ReceiverMailboxManager.prototype.updateSendStatus=function(d,b){if(_.isArray(d)){b=b?true:false;var g={addr:d.length===1?d[0]:d};var f=this.addrs(g).update({sent:b}).count();debug("更改邮箱"+(b?"已发送":"未发送")+"状态数目："+f);if(b){if(this.canReportSendInfo()){var a={};if(_.isString(d)){a[d]=this.smStatus.sendSuccess}else{if(_.isArray(d)){_.each(d,function(c){a[c]=this.smStatus.sendSuccess},this)}else{throw"错误的数据类型(sent)"}}var e=this;this.reportSendInfo(a,this.smStatus.sendSuccess,function(){e.addrs(g).remove();e.storeStatus()})}}return f}else{throw"邮箱地址参数类型错误！"}};ReceiverMailboxManager.prototype.sent=function(a){return this.updateSendStatus(a,true)};ReceiverMailboxManager.prototype.unsent=function(a){return this.updateSendStatus(a,false)};ReceiverMailboxManager.prototype.reportRemaining=function(){if(this.canReportSendInfo()){var d=this;var b=this.addrs().get();if(b&&b.length){var c={};_.each(b,function(a){c[a.addr]=a.sent?d.smStatus.sendSuccess:d.smStatus.notSend},d);d.reportSendInfo(c,d.smStatus.notSend,function(){info("保存未发送邮箱到远程数据库。");d.setAddrs([])})}}};ReceiverMailboxManager.prototype.invalid=function(e){var d={};var b=[];if(_.isString(e)){b.push(e);d[e]=1}else{if(_.isArray(e)){_.each(e,function(a,c){d[a]=1},this);b=d[e]=1}else{if(_.isObject(e)){d=e;b=_.keys(d)}else{throw"邮箱地址参数类型错误！"}}}var f=this.addrs({addr:b}).remove();this.postInvalid(d);debug("无效邮箱个数："+f);return f};ReceiverMailboxManager.prototype.getTotal=function(){return this.addrs?this.addrs().count():0};ReceiverMailboxManager.prototype.empty=function(){return this.getTotal()===0};ReceiverMailboxManager.prototype.checkAddrs=function(b){if(_.isString(b)){b=b.split(this.addressTextSeperatorRegex)}else{if(!_.isArray(b)){throw"参数类型错误！"}}var c=this.defaultHostName;_.each(b,function(a,d){if(a.indexOf("@")===-1){if(!c){throw"请设置默认域名！存在没有域名的邮箱地址！"}b[d]=a+"@"+c}},this);return b};ReceiverMailboxManager.prototype.showAddrs=function(){if(this.$addrs){var b=this.getTotal();if(b>0){this.$addrs.val(this.addrs().select("addr").join("\r\n"));var a=this.getUnsentCount();this.$total.text("("+b+"-"+(b-a)+"-"+a+")")}else{this.$addrs.val("");this.$total.empty()}}};ReceiverMailboxManager.prototype.canFetch=function(){return this.urls&&this.urls.request&&this.urls.request.value&&!this.noFetch};ReceiverMailboxManager.prototype.getWaitSeconds=function(){return this.waitSeconds||5};ReceiverMailboxManager.prototype.fetchMailbox=function(){if(!this.canFetch()){return false}var b=this;if(!b.fetchingMailbox){b.fetchingMailbox=true}else{return}var a={sender:b.sender,count:100};GM_xmlhttpRequest({method:"POST",url:b.urls.request.value,data:JSON.stringify(a),headers:{"Content-Type":"text/plain"},onerror:function(c){error(c.status+": "+c.responseText);GM_log(c.responseText);b.fetchingMailbox=false},onload:function(c){b.fetchingMailbox=false;if(c.status==200){try{var d=JSON.parse(c.responseText);if(!d.ok){info(d.desc)}else{b.addAddrs(d.mailbox);info("取得邮箱数量："+d.mailbox.length)}}catch(e){error(e)}}else{info(c.responseText)}}})};ReceiverMailboxManager.prototype.postInvalid=function(a){if(this.canPostMailbox()){this.postMailbox(a,this.mbStatus.notExist)}};ReceiverMailboxManager.prototype.canPostMailbox=function(){return this.urls&&this.urls.save&&this.urls.save.value};ReceiverMailboxManager.prototype.postMailbox=function(d,c,b){var g=this;if(!g.canPostMailbox()){return false}var f=[];if(_.isString(d)){d=[d]}var a=_.isArray(d);var e=_.isObject(d);if(!a&&!e){throw"错误数据类型(postMailbox)"}_.each(d,function(h,l){var m=a?h:l;var k=m.indexOf("@");if(k===-1||k===0||k===m.length-1){error("错误邮箱地址："+m)}else{f.push({domain:m.substring(k+1),username:m.substring(0,k),status:(a?c:h)})}},this);GM_xmlhttpRequest({method:"POST",url:g.urls.save.value,data:JSON.stringify(f),headers:{"Content-Type":"text/plain"},onerror:function(h){error(h.status+": "+h.responseText);GM_log(h.responseText)},onload:function(h){info(h.responseText);if(h.status==200){if(_.isFunction(b)){b.call(g)}}}})};ReceiverMailboxManager.prototype.canReportSendInfo=function(a){return this.urls&&this.urls.report&&this.urls.report.value};ReceiverMailboxManager.prototype.reportSendInfo=function(c,b,g){var h=this;if(!h.canReportSendInfo()){return false}var e=[];if(_.isString(c)){c=[c]}var a=_.isArray(c);var d=_.isObject(c);if(!a&&!d){throw"错误数据类型(postSent)"}_.each(c,function(k,m){var n=a?k:m;var l=n.indexOf("@");if(l===-1||l===0||l===n.length-1){error("错误邮箱地址："+n)}else{e.push({domain:n.substring(l+1),username:n.substring(0,l),status:a?b:k})}},this);var f={sender:h.sender,mailbox:e};GM_xmlhttpRequest({method:"POST",url:h.urls.report.value,data:JSON.stringify(f),headers:{"Content-Type":"text/plain"},onerror:function(i){error(i.status+": "+i.responseText);GM_log(i.responseText)},onload:function(i){info(i.responseText);if(i.status===200){if(_.isFunction(g)){g.call(h)}}}})};ReceiverMailboxManager.prototype.buildUI=function(){var c=this;this.$ui=jQuery("<div class='toTop'/>");var b=jQuery("<div/>").css(rowCss).appendTo(this.$ui);jQuery("<label/>").text("每次发送的收件人数量范围:").appendTo(b);this.$eMin=jQuery("<input type='text' size='4' maxlength='3' class='enableWhenStop'/>").appendTo(b).val(this.eMin);jQuery("<span/>").text("～").appendTo(b);this.$eMax=jQuery("<input type='text' size='4' maxlength='3' class='enableWhenStop'/>").css(columnCss).appendTo(b).val(this.eMax);jQuery("<button class='enableWhenStop'/>").appendTo(b).button({label:"保存"}).click(function(k){try{var g=gt0Validator.check(c.$eMin.val(),"最小值");var e=gt0Validator.check(c.$eMax.val(),"最大值");if(g>e){var f=g;g=e;e=f}c.eMin=g;c.eMax=e;c.storeProp("eMin","eMax");info("已保存.")}catch(h){c.$eMin.val(c.eMin);c.$eMax.val(c.eMax);confirmMessage(h)}});b=jQuery("<div/>").css(rowCss).appendTo(this.$ui);jQuery("<label/>").text("无域名邮箱地址的默认域名:").appendTo(b);jQuery("<span/>").css({"font-weight":"bolder"}).text("@").appendTo(b);this.$defaultHostName=jQuery("<input type='text' size='16' maxlength='64' class='enableWhenStop'/>").attr("title","改后请按回车键").appendTo(b).change(function(f){var e=jQuery.trim(this.value);if(e.length>0){if(validHostNameRegex.test(e)){c.defaultHostName=e;c.storeProp("defaultHostName");info("已保存域名 "+e)}else{confirmMessage("错误域名:"+e);c.$defaultHostName.val(c.defaultHostName||"")}}else{e=c.defaultHostName;c.defaultHostName=null;c.storeProp("defaultHostName");info("已删除 "+e)}});this.$defaultHostName.val(this.defaultHostName||"");b=jQuery("<div/>").css(rowCss).text("用换行符或英文逗号或英文分号分隔邮箱地址。").appendTo(this.$ui);this.$addrs=jQuery("<textarea class='enableWhenStop'/>").css({width:"97%",height:"60px","font-family":"inherit","font-size":"inherit"}).appendTo(b);b=jQuery("<div/>").css(rowCss).appendTo(this.$ui);jQuery("<button title='确定修改后请按' class='enableWhenStop'/>").appendTo(b).button({label:"保存"}).css(columnCss).click(function(h){var f=jQuery.trim(c.$addrs.val());if(f.length===0){c.setAddrs([])}else{try{var e=c.checkAddrs(f.toLowerCase());c.setAddrs(e)}catch(g){confirmMessage(g)}}c.storeStatus()});jQuery("<button title='恢复到修改前' class='enableWhenStop'/>").appendTo(b).button({label:"恢复"}).css(columnCss).click(function(e){c.showAddrs()});jQuery("<button class='enableWhenStop'/>").appendTo(b).css(columnCss).button({label:"删除"}).click(function(e){c.setAddrs([]);c.storeStatus()});jQuery("<button class='enableWhenStop'/>").appendTo(b).css(columnCss).button({label:"再次发送"}).click(function(e){c.sendAgain();c.showAddrs()});var a=this;var d=_.uniqueId("cb_");jQuery("<input type='checkbox'/>").attr({id:d,name:d}).appendTo(b).change(function(e){a.noFetch=this.checked});jQuery("<label/>").attr({"for":d}).text("不再远程取邮箱").css(columnCss).appendTo(b);this.$total=jQuery("<span/>").attr("title","总数-已发-未发").appendTo(b);this.showAddrs();jQuery.each(this.urls,function(f,g){var e=jQuery("<div/>").css(rowCss).appendTo(a.$ui);var h=_.uniqueId(f+"_");jQuery("<label for='"+h+"'>").text(g.label).appendTo(e);jQuery("<input type='text' size='38'/>").attr({title:"双击恢复默认值",id:h,name:h}).val(g.value).appendTo(e).change({id:f},function(j){var i=a.urls[j.data.id]=jQuery.trim(jQuery(this).val());GM_setValue("url_"+j.data.id,i)}).dblclick({dv:g.dv},function(i){this.value=i.data.dv})});return this.$ui};
