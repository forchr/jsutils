var validHostNameRegex=new RegExp("^([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9])(.([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9]))*$");function ReceiverMailboxManager(){StoreManager.call(this,["addrs","eMin","eMax","defaultHostName"],"to.");this.addressTextSeperatorRegex=/(?:[\r\n,;])+/;this.addrs=TAFFY();this.eMin=1;this.eMax=5;this.uiTitle="邮箱"}ReceiverMailboxManager.prototype=Object.create(StoreManager.prototype);ReceiverMailboxManager.prototype.constructor=ReceiverMailboxManager;ReceiverMailboxManager.prototype.getUIPropId=function(a){return eventLoopId+"-to-"+a};ReceiverMailboxManager.prototype.buildAddrObj=function(a){return{addr:a,sent:false}};ReceiverMailboxManager.prototype.fromStoreValue=function(b,a){if(b==="addrs"){return TAFFY(a)}return a};ReceiverMailboxManager.prototype.toStoreValue=function(b,a){if(b==="addrs"){if(this.addrs&&this.addrs().count()>0){return this.addrs().stringify()}else{return undefined}}return a};ReceiverMailboxManager.prototype.storeStatus=function(){this.storeProp("addrs");this.showAddrs();return this};ReceiverMailboxManager.prototype.setAddrs=function(b){this.addrs=TAFFY();_.each(b,function(a,c){this.addrs.insert(this.buildAddrObj(a))},this);debug("邮箱数:"+b.length);return this};ReceiverMailboxManager.prototype.sendAgain=function(){this.addrs().update({sent:false});return this};ReceiverMailboxManager.prototype.getUnsentCount=function(){return this.addrs({sent:false}).count()};ReceiverMailboxManager.prototype.hasUnsent=function(){return this.getUnsentCount()>0};ReceiverMailboxManager.prototype.getForSend=function(b){var a=this.getUnsentCount();if(a<1){return null}if(a>b){a=b}var c=this.eMin===this.eMax?this.eMax:_.random(this.eMin,this.eMax);if(c>a){c=a}return this.addrs({sent:false}).limit(c).select("addr")};ReceiverMailboxManager.prototype.updateSendStatus=function(b,a){if(_.isArray(b)){a=a?true:false;var e={addr:b.length===1?b[0]:b};var d=this.addrs(e).update({sent:a}).count();debug("更改邮箱"+(a?"已发送":"未发送")+"状态数目："+d);return d}else{throw"邮箱地址参数类型错误！"}};ReceiverMailboxManager.prototype.sent=function(a){return this.updateSendStatus(a,true)};ReceiverMailboxManager.prototype.unsent=function(a){return this.updateSendStatus(a,false)};ReceiverMailboxManager.prototype.invalid=function(a){if(_.isArray(a)||_.isString(a)){var b=this.addrs({addr:a}).remove();debug("删除无效邮箱个数："+b);return b}else{throw"邮箱地址参数类型错误！"}};ReceiverMailboxManager.prototype.getTotal=function(){return this.addrs?this.addrs().count():0};ReceiverMailboxManager.prototype.empty=function(){return this.getTotal()===0};ReceiverMailboxManager.prototype.checkAddrs=function(b){if(_.isString(b)){b=b.split(this.addressTextSeperatorRegex)}else{if(!_.isArray(b)){throw"参数类型错误！"}}var c=this.defaultHostName;_.each(b,function(a,d){if(a.indexOf("@")===-1){if(!c){throw"请设置默认域名！存在没有域名的邮箱地址！"}b[d]=a+"@"+c}},this);return b};ReceiverMailboxManager.prototype.showAddrs=function(){if(this.$addrs){var b=this.getTotal();if(b>0){this.$addrs.val(this.addrs().select("addr").join("\r\n"));var a=this.getUnsentCount();this.$total.text("("+b+"-"+(b-a)+"-"+a+")")}else{this.$addrs.val("");this.$total.empty()}}};ReceiverMailboxManager.prototype.buildUI=function(){var b=this;this.$ui=jQuery("<div class='toTop'/>");var a=jQuery("<div/>").css(rowCss).appendTo(this.$ui);jQuery("<label/>").text("每次发送的收件人数量范围:").appendTo(a);this.$eMin=jQuery("<input type='text' size='4' maxlength='3' class='enableWhenStop'/>").appendTo(a).val(this.eMin);jQuery("<span/>").text("～").appendTo(a);this.$eMax=jQuery("<input type='text' size='4' maxlength='3' class='enableWhenStop'/>").css(columnCss).appendTo(a).val(this.eMax);jQuery("<button class='enableWhenStop'/>").appendTo(a).button({label:"保存"}).click(function(g){try{var e=gt0Validator.check(b.$eMin.val(),"最小值");var c=gt0Validator.check(b.$eMax.val(),"最大值");if(e>c){var d=e;e=c;c=d}b.eMin=e;b.eMax=c;b.storeProp("eMin","eMax");info("已保存.")}catch(f){b.$eMin.val(b.eMin);b.$eMax.val(b.eMax);confirmMessage(f)}});a=jQuery("<div/>").css(rowCss).appendTo(this.$ui);jQuery("<label/>").text("无域名邮箱地址的默认域名:").appendTo(a);jQuery("<span/>").css({"font-weight":"bolder"}).text("@").appendTo(a);this.$defaultHostName=jQuery("<input type='text' size='16' maxlength='64' class='enableWhenStop'/>").attr("title","改后请按回车键").appendTo(a).change(function(d){var c=jQuery.trim(this.value);if(c.length>0){if(validHostNameRegex.test(c)){b.defaultHostName=c;b.storeProp("defaultHostName");info("已保存域名 "+c)}else{confirmMessage("错误域名:"+c);b.$defaultHostName.val(b.defaultHostName||"")}}else{c=b.defaultHostName;b.defaultHostName=null;b.storeProp("defaultHostName");info("已删除 "+c)}});this.$defaultHostName.val(this.defaultHostName||"");a=jQuery("<div/>").css(rowCss).text("用换行符或英文逗号或英文分号分隔邮箱地址。").appendTo(this.$ui);this.$addrs=jQuery("<textarea class='enableWhenStop'/>").css({width:"97%",height:"60px","font-family":"inherit","font-size":"inherit"}).appendTo(a);a=jQuery("<div/>").css(rowCss).appendTo(this.$ui);jQuery("<button title='确定修改后请按' class='enableWhenStop'/>").appendTo(a).button({label:"保存"}).css(columnCss).click(function(f){var d=jQuery.trim(b.$addrs.val());if(d.length===0){b.setAddrs([])}else{try{var c=b.checkAddrs(d);b.setAddrs(c)}catch(e){confirmMessage(e)}}b.storeProp("addrs").showAddrs()});jQuery("<button title='恢复到修改前' class='enableWhenStop'/>").appendTo(a).button({label:"恢复"}).css(columnCss).click(function(c){b.showAddrs()});jQuery("<button class='enableWhenStop'/>").appendTo(a).css(columnCss).button({label:"再次从头发送"}).click(function(c){b.sendAgain();b.showAddrs()});this.$total=jQuery("<span/>").attr("title","总数-已发-未发").appendTo(a);this.showAddrs();return this.$ui};
