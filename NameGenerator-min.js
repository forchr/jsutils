var charsets={pinyins:["a","ai","an","ang","ao","ba","bai","ban","bang","bao","bei","ben","beng","bi","bian","biao","bie","bin","bing","bo","bu","ca","cai","can","cang","cao","ce","cen","ceng","cha","chai","chan","chang","chao","che","chen","cheng","chi","chong","chou","chu","chua","chuai","chuan","chuang","chui","chun","chuo","ci","cong","cou","cu","cuan","cui","cun","cuo","da","dai","dan","dang","dao","de","den","dei","deng","di","dia","dian","diao","die","ding","diu","dong","dou","du","duan","dui","dun","duo","e","ei","en","eng","er","fa","fan","fang","fei","fen","feng","fo","fou","fu","ga","gai","gan","gang","gao","ge","gei","gen","geng","gong","gou","gu","gua","guai","guan","guang","gui","gun","guo","ha","hai","han","hang","hao","he","hei","hen","heng","hong","hou","hu","hua","huai","huan","huang","hui","hun","huo","ji","jia","jian","jiang","jiao","jie","jin","jing","jiong","jiu","ju","juan","jue","jun","ka","kai","kan","kang","kao","ke","ken","keng","kong","kou","ku","kua","kuai","kuan","kuang","kui","kun","kuo","la","lai","lan","lang","lao","le","lei","leng","li","lia","lian","liang","liao","lie","lin","ling","liu","long","lou","lu","luan","lue","lun","luo","m","ma","mai","man","mang","mao","me","mei","men","meng","mi","mian","miao","mie","min","ming","miu","mo","mou","mu","na","nai","nan","nang","nao","ne","nei","nen","neng","ng","ni","nian","niang","niao","nie","nin","ning","niu","nong","nou","nu","nuan","nuo","nun","o","ou","pa","pai","pan","pang","pao","pei","pen","peng","pi","pian","piao","pie","pin","ping","po","pou","pu","qi","qia","qian","qiang","qiao","qie","qin","qing","qiong","qiu","qu","quan","que","qun","ran","rang","rao","re","ren","reng","ri","rong","rou","ru","ruan","rui","run","ruo","sa","sai","san","sang","sao","se","sen","seng","sha","shai","shan","shang","shao","she","shei","shen","sheng","shi","shou","shu","shua","shuai","shuan","shuang","shui","shun","shuo","si","song","sou","su","suan","sui","sun","suo","ta","tai","tan","tang","tao","te","teng","ti","tian","tiao","tie","ting","tong","tou","tu","tuan","tui","tun","tuo","wa","wai","wan","wang","wei","wen","weng","wo","wu","xi","xia","xian","xiang","xiao","xie","xin","xing","xiong","xiu","xu","xuan","xue","xun","ya","yan","yang","yao","ye","yi","yin","ying","yo","yong","you","yu","yuan","yue","yun","za","zai","zan","zang","zao","ze","zei","zen","zeng","zha","zhai","zhan","zhang","zhao","zhe","zhei","zhen","zheng","zhi","zhong","zhou","zhu","zhua","zhuai","zhuan","zhuang","zhui","zhun","zhuo","zi","zong","zou","zu","zuan","zui","zun","zuo"],letters:["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],digits:["0","1","2","3","4","5","6","7","8","9"]};var charsetCaptions={pinyins:"拼音",letters:"字母",digits:"数字"};var spanCss={margin:"0 3px"};function NameGenerator(d){var c;this.init=function(l){var f=[];var j=[];var h=[];for(var g=0;g<l.length;g++){var k=l[g];f[g]=k.max>=0&&k.max<k.charset.length?k.max:k.charset.length-1;h[g]=k.min;j[g]=k.cur}c=new IndexesCombination(f,j,h);f=c.getMaxes();var j=c.getCurrentIndexes();h=c.getMins();for(var g=0;g<l.length;g++){var k=l[g];k.max=f[g];k.min=h[g];k.cur=j[g]}};if(d instanceof Array){this.init(d)}this.getIndexer=function(){return c};var e=0;var b;var a;this.nextName=function(){b=new Array();a=new Array();e++;if(c.next(b)){for(var f=0;f<b.length;f++){var g=d[f];g.cur=b[f];a[f]=g.charset[g.cur]}return a.join("")}return false};this.getCurrentIndexAndCharArrays=function(){return[b,a]};this.next=function(){var g=600;var h=0;while(!stopCommandReceived&&h<g){var f=this.nextName();h++;if(!this.regex||false===f||this.regex.test(f)){return f}}if(h>=g){throw"太多不符合要求的名称！"}}}function CompositionNameGenerator(){var t=this;var m;function u(){var x=GM_getValue("nameParts");console.debug("restore nameParts: ",x);if(!x){x=[{charset:charsets.pinyins,charsetName:"pinyins"},{charset:charsets.pinyins,charsetName:"pinyins"},{charset:charsets.pinyins,charsetName:"pinyins"}]}else{x=JSON.parse(x);for(var s=0;s<x.length;s++){var w=x[s];if(_.isString(w.charsetName)&&w.charsetName.length>0){w.charset=charsets[w.charsetName];if(w.charset===undefined){warn("未知字符集: "+w.charsetName);break}}}}return x}function e(){var s=[];for(var w=0;w<m.length;w++){var x=m[w];s[w]=jQuery.extend({},x,{charset:null});if(_.isString(x.charsetName)&&x.charsetName.length>0){s[w].charset=[]}}GM_setValue("nameParts",JSON.stringify(s))}function h(){jQuery.each(m,function(s,w){d[s].val(w.cur)})}this.saveStatus=function(){e();h()};var l=jQuery("<div/>");this.getUI=function(){return l};var f;var v=_.uniqueId("npstb-");var k='<form class="nameConfigForm" onsubmit="return false;"><table class="ev '+v+' ui-widget"><thead class=\'ui-widget-header\'><tr><th>序号</th><th>输入字集</th><th>选择字集</th><th title=\'从0开始\'>字的序号</th><th title=\'辅助功能，输入后按回车键\'>序号与字</th></tr></thead><tfoot class=\'ui-widget-header\'><tr><td><input type="button" value="修改" title="修改后请点击" class="updateNameParts enableWhenStop"/></td><td><input type="button" value="增加" class="addNamePart enableWhenStop"/></td><td><input type="button" value="删除" class="deleteNamePart enableWhenStop"/></td><td></td><td></td></tr></tfoot><tbody>'+(f='<tr class="namePart"><td><input class="namePart enableWhenStop" type="checkbox" /><label class=\'npNo\' style=\'margin-left:3px;\'>1</label></td><td><textarea class="charsetInput enableWhenStop" style="width:150px;height:3em;" title="字集"></textarea></td><td><select class="charsetInputMethod enableWhenStop"><option value="">自定义</option><option value="pinyins">拼音</option><option value="letters">字母</option><option value="digits">数字</option></select></td><td><input class="indexMin integer enableWhenStop" style=\'width:2em;padding:0;margin:0;\' size="2" maxlength="5" title="最小值"/>&lt;=<input class="indexCur enableWhenStop" style=\'width:2em;padding:0;margin:0;\' size="2" maxlength="5" title="当前值"/>&lt;=<input class="indexMax integer enableWhenStop" style=\'width:2em;padding:0;margin:0;\' size="2" maxlength="5" title="最大值"/></td><td><input class="indexOf enableWhenStop" style=\'width:2em;padding:0;margin:0;\' size="2" maxlength="5" title="序号,双击或回车键"/>-<input class="charOf enableWhenStop" style=\'width:3em;padding:0;margin:0;\' size="2" maxlength="5" title="字"/></td></tr>')+"</tbody></table></form>";jQuery("<div/>").text("用逗号或换行符分隔字。").appendTo(l);var i=jQuery(k).appendTo(l);var a=jQuery("<div/>").appendTo(l);var r=jQuery("<div/>").appendTo(l);function p(){i.find("tr.namePart").each(function(s,w){jQuery("label.npNo",w).text(s+1)})}i.find("input.addNamePart").on("click",function(s){jQuery(f).appendTo(i.find("table."+v+" > tbody")).find("input.integer").number(true,0,"","");p()});i.find("input.deleteNamePart").on("click",function(s){i.find("tr.namePart").each(function(w,x){if(jQuery(x).find("input.namePart:checked").length>0){jQuery(x).remove()}});p()});i.on("change","select.charsetInputMethod",function(A){var y=jQuery(this).parentsUntil("tbody").find("textarea.charsetInput");var x=jQuery(this).val();var z="";if(x.length>0){z=charsets[x].join(",")}if(z.length>0){y.val(z)}});i.on("mouseup","textarea.charsetInput",function(s){var w=jQuery(this).textrange("get");if(w.text.length>0){jQuery(this).parentsUntil("tbody").find("input.charOf").val(w.text).change()}});i.on("change dblclick","input.indexOf",function(z){var x=jQuery.trim(this.value);if(x.length===0){x=jQuery(this).parentsUntil("tbody").find("input.indexCur").val()}if(x.length===0){x=0}x=parseInt(x);if(isNaN(x)){this.value="";return}var y=jQuery(this).next("input");var w=jQuery(this).parentsUntil("tbody").find("textarea.charsetInput");var s=_.without(jQuery.trim(w.val()).split(tokenSepRegExp),"");if(s.length===0){y.val("无")}if(x<0){x=s.length-Math.abs(x);if(x<0){x=0}}else{if(x>=s.length){x=s.length-1}}y.val(s[x]);this.value=x});i.on("change","input.charOf",function(B){var y=jQuery.trim(this.value);if(y.length===0){return}var z=jQuery(this).prev("input");var x=jQuery(this).parentsUntil("tbody").find("textarea.charsetInput");var s=_.without(jQuery.trim(x.val()).split(tokenSepRegExp),"");if(s.length===0){z.val("无")}else{var A=jQuery.inArray(y,s);z.val(A>=0?A:"无")}});var b={min:"indexMin",cur:"indexCur",max:"indexMax"};i.find("input.updateNameParts").on("click",function(w){var x=[];try{i.find("tr.namePart").each(function(z,C){var B=jQuery(this);var A=B.find("select.charsetInputMethod");var D=A.val();var y={};if(D.length===0){var G=jQuery.trim(B.find("textarea.charetInput").val());if(G.length===0){throw"必须输入字集！"}y.charset=_.without(G.split(tokenSepRegExp),"")}else{y.charset=charsets[D];if(y.charset===undefined||y.charset===null){throw"未知字集名称: "+D}y.charsetName=D}var F={};jQuery.each(b,function(J,L){var K=B.find("input."+L);var I=K.val();var H=parseInt(jQuery.trim(I));if(isNaN(H)||H<0){if(L==="indexCur"){H=-1}else{H=0}}y[J]=H;F[J]=K});if(y.max===0){y.max=y.charset.length-1}if(y.min>y.max){var E=y.min;y.min=y.max;y.max=E}if(y.cur<y.min-1){y.cur=y.min-1}jQuery.each(F,function(H,I){I.val(y[H])});x.push(y)})}catch(s){confirmMessage(s);return}if(x.length===0){confirmMessage("必须输入至少一个子集！");return}g();m=x;t.ng=new NameGenerator(m);t.saveStatus();debug("重新设置了邮址生成器")});m=u();var d;var o;var c;function g(){d=[];o=[];c=[];i.find("tr.namePart").each(function(s,x){var w=jQuery(x);d.push(w.find("input.indexCur"));o.push(w.find("input.indexOf"));c.push(w.find("input.charOf"))})}function j(){var w=m.length-i.find("tr.namePart").length;if(w>0){for(var s=0;s<w;s++){i.find("input.addNamePart").trigger("click")}}else{if(w<0){w=-w;i.find("input.addNamePart:lt("+w+")").remove()}}i.find("tr.namePart").each(function(z,B){var C=m[z];var A=jQuery(B);var y=A.find("textarea.charsetInput");var x=A.find("select.charsetInputMethod");y.val(C.charset.join(","));x.val(C.charsetName||"");jQuery.each(b,function(D,E){A.find("input."+E).val(C[D])})});g()}this.ng=new NameGenerator(m);j();i.find("input.integer").number(true,0,"","");var q="\\w{6,18}";var n=GM_getValue("nameRegex");console.debug("restore nameRegex ",n);this.ng.regex=this.nameRegex=new RegExp(n||q);jQuery("<label/>").text("名称正则表达式:").appendTo(a);jQuery("<input type='text'/>").addClass("enableWhenStop").css({width:"20em"}).appendTo(a).val(this.nameRegex.source).attr("title","默认值:"+q).change(function(x){var w=jQuery.trim(this.value);if(w.length===0){t.ng.regex=t.nameRegex=null;GM_deleteValue("nameRegex")}else{t.ng.regex=t.nameRegex=new RegExp(w);GM_setValue("nameRegex",w);debug("设置了名称正则表达式。已保存。")}});this.next=function(s){var w=this.ng.next();var y=this.ng.getCurrentIndexAndCharArrays();if(y&&y[0]){for(var x=0;x<y[0].length;x++){o[x].val(y[0][x]);c[x].val(y[1][x])}r.text("轮到组合: "+y[0].join("-")+" / "+y[1].join("-"))}return w}};
