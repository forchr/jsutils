function MailboxStore(){this.addrs=[];try{var d=GM_getValue("addrs");if(d){this.addrs=JSON.parse(d)}}catch(c){debug(c);this.addrs=[]}this.max=300;this.count=0;this.defaultURL="http://localhost:9080/mailbox/save";this.url=GM_getValue("url",this.defaultURL)}MailboxStore.prototype.getCount=function(){return this.addrs.length};MailboxStore.prototype.checkStartConditions=function(){if(this.getCount()>=this.max){throw"请保存检测出的注册邮箱地址，再继续！"}};MailboxStore.prototype.save=function(a){if(a&&a.length){for(var d=0;d<a.length;d++){if(_.indexOf(this.addrs,a[d])===-1){this.addrs.push(a[d]);this.count++}}}GM_setValue("addrs",JSON.stringify(this.addrs));if(this.addrs.length){this.post()}return this};MailboxStore.prototype.post=function(l){if(!l){l=this.addrs}if(l.length===0){return}var h=[];for(var j=0;j<l.length;j++){var i=l[j];var k=i.indexOf("@");if(k>0){h.push({domain:i.substring(k+1),username:i.substring(0,k),status:4})}}if(h.length===0){error("错误邮箱地址！");return}var a=this;GM_xmlhttpRequest({method:"POST",url:this.url,data:JSON.stringify(h),headers:{"Content-Type":"text/plain"},onerror:function(b){error(b.status+": "+b.responseText);GM_log(b.responseText)},onload:function(b){if(b.status==200){a.addrs=l==a.addrs?[]:_.difference(a.addrs,l);a.save().showData()}info(b.responseText)}})};MailboxStore.prototype.showData=function(){this.$text.val(this.addrs.join("\r\n"));this.$total.text("本地:"+this.addrs.length+"(累计:"+this.count+")");return this};MailboxStore.prototype.clear=function(){GM_deleteValue("addrs");this.addrs=[];return this};MailboxStore.prototype.buildUI=function(){var h=jQuery("<div/>");var j=jQuery("<div/>").appendTo(h);j.text("邮箱地址总数:");this.$total=jQuery("<span/>").appendTo(j);var f=jQuery("<div/>").appendTo(h);this.$text=jQuery("<textarea/>").css({width:"98%",height:"160px"}).appendTo(f);var g=this;jQuery("<button/>").text("清空").appendTo(j).css({"margin-left":"20px"}).click(function(a){jQuery("<div/>").text("请手动存到别的文件后再清除！以免数据丢失。确定要继续清空？").css({"text-align":"left"}).dialog({title:"先保存",modal:true,height:260,width:340,resizable:true,buttons:[{text:"确定清空",click:function(){g.clear().showData();jQuery(this).dialog("close").dialog("destroy")}},{text:"取消",click:function(){jQuery(this).dialog("close").dialog("destroy")}}]})});jQuery("<button/>").text("保存到数据库").appendTo(j).css({"margin-left":"20px"}).click(function(a){debug("save db");if(g.addrs.length){g.post()}else{var b=jQuery.trim(g.$text.val()).split(/[\s,;]+/g);if(b.length){g.post(b)}}});this.showData();var g=this;var i=jQuery("<div/>").appendTo(h);jQuery("<span/>").text("数据库url:").appendTo(h);jQuery("<input type='text' size='60'/>").val(this.url).attr("title","双击恢复默认值").appendTo(h).change(function(a){g.url=jQuery.trim(jQuery(this).val());GM_setValue("url",g.url)}).dblclick(function(a){this.value=g.defaultURL});return h};
