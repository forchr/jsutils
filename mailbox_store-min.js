function MailboxStore(){this.addrs=[];try{var a=GM_getValue("addrs");if(a){this.addrs=JSON.parse(a)}}catch(b){debug(b);this.addrs=[]}this.max=300;this.count=0;this.url="http://localhost:9080/mailbox/save"}MailboxStore.prototype.getCount=function(){return this.addrs.length};MailboxStore.prototype.checkStartConditions=function(){if(this.getCount()>=this.max){throw"请保存检测出的注册邮箱地址，再继续！"}};MailboxStore.prototype.save=function(d){var c=[];for(var e=0;e<d.length;e++){if(_.indexOf(this.addrs,d[e])===-1){this.addrs.push(d[e]);this.count++;c.push(d[e])}}GM_setValue("addrs",JSON.stringify(this.addrs));this.post(c);return this};MailboxStore.prototype.post=function(b){var d=jQuery.param({username:b.join(",")});var c=this.url;c=c+(c.indexOf("?")>0?"&":"?")+d;GM_xmlhttpRequest({method:"GET",url:c,context:this,onerror:function(a){error(a.status+": "+a.responseText);GM_log(a.responseText)},onload:function(a){if(a.status==200){a.context.addrs=_.difference(a.context.addrs,b);a.context.save().showData()}info(a.responseText)}})};MailboxStore.prototype.showData=function(){this.$text.val(this.addrs.join("\r\n"));this.$total.text("本地:"+this.addrs.length+"(累计:"+this.count+")");return this};MailboxStore.prototype.clear=function(){GM_deleteValue("addrs");this.addrs=[];return this};MailboxStore.prototype.buildUI=function(){var d=jQuery("<div/>");var c=jQuery("<div/>").appendTo(d);c.text("邮箱地址总数:");this.$total=jQuery("<span/>").appendTo(c);var b=jQuery("<div/>").appendTo(d);this.$text=jQuery("<textarea/>").css({width:"98%",height:"80px"}).appendTo(b);var a=this;jQuery("<button/>").text("清空").appendTo(c).css({"margin-left":"20px"}).click(function(e){jQuery("<div/>").text("请手动存到别的文件后再清除！以免数据丢失。确定要继续清空？").css({"text-align":"left"}).dialog({title:"先保存",modal:true,height:260,width:340,resizable:true,buttons:[{text:"确定清空",click:function(){a.clear().showData();jQuery(this).dialog("close").dialog("destroy")}},{text:"取消",click:function(){jQuery(this).dialog("close").dialog("destroy")}}]})});jQuery("<button/>").text("保存到数据库").appendTo(c).css({"margin-left":"20px"}).click(function(f){if(a.addrs.length){a.post(a.addrs)}else{var e=jQuery.trim(a.$text.val()).split(/[\\s,;]+/g);if(e.length){a.post(a.addrs)}}});this.showData();return d};
